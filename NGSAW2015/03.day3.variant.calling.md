## 第3天 Variant Calling

### ppt: Mapping and assembly basics

What is mapping? What genes and how many?

Variantions? SNP calling - which Variants are "real"?

长read vs 短read

+ 与短read的mapping相比，mapping长read是不同的问题
+ 有以下两个原因：  
  - 数据的体积小很多： 1M 454 vs 200M+ Illumina  
  - 长read是更加可能包含indels

How alignment works, and why indel are the devil?

There are many strategies, but most work like this:

At each base, try extending alignment; is total score still above threshold?

Each mismatch costs.

Indels introduce lots more ambiguity.

Want global(全局)，而非local(局部) alignment: 不要试图在read内进行匹配（像使用blast等局部比对搜索工具）。

Mapping是平行处理：

+ 目标是将每一个read放置到其在基因组的相应位置上
+ 所以，可以分别map read

使mapping具有挑战性的因素：

+ 数据 容量
+ 垃圾read
+ read错误与质量值
+ 重复元件与多拷贝序列
+ SNP与SNV
+ indel
+ 剪切（转录组）

两个特殊的mapping工具：

+ Bowtie

		Bowtie v1：无法mapping across indels
		Bowtie v2：更慢但更加灵活

+ BWA

这两个程序都是开源的，目前BWA使用最多。

需要思考的问题：

+ 是否胜任Indel
+ 内存效率
+ 好的文档
+ 被保持的

Bowtie1

+ 不支持indel，在Bowtie2中修复；
+ 为以下情况设计  
  - 许多read具有一个好的合法的alignment  
  - 许多read具有高质量
  - 小数量的比对/read

BWA

+ 与Bowtie使用相似的策略，但可以进行gapped比对
+ 最新最火的工具
+ 由mapping god李恒书写代码

使用mapping工具时需要你作出的决定：

+ 允许多少错配
+ 报道多少匹配（多匹配）
+ 要求最佳匹配或者第一个/任意一个符合标准的匹配

**最好在整个reference上进行mapping**

看一下你的mapping：就像统计学一样，总是需要看一下你的“Raw data”。

mapping第一步：index reference

Mapping软件会忽略一部分具有错误的read。

mapping软件的选择有关系吗？其实，reference的挽着该您度和read质量更加重要。

一些问题：

+ 转录组和细菌基因组具有较少的repeat
+ 转录组需要考虑shared exon
+ 对于genotyping/assoiation的研究（ASE）不要考虑indel太多

**第二部分： De novo Assembly**

特点：

+ 不需要reference
+ 需要更大的计算机
+ 生物学阻碍（repeat）
+ 需要更高的覆盖度

Assembly的挑战：突变/取样/错误和无reference

de novo Assembly的4个主要挑战：

1. repeat
2. 低覆盖度
3. 错误
4. 覆盖度的变化（转录组/宏基因组/扩增基因组）

这挑战着组装软件识别错误连接和真实连接的能力。

由于取样是随机的，因此真实的覆盖度与平均覆盖度相比变化很大。

两种基本的assembly方法：

+ Overlap（重叠）/layout（排列）/consensus（一致）  
  1. 计算所有的重叠
  2. 根据重叠进行成簇化
  3. 进行多序列比对

+ De Bruijin k-mer graphs

前者适用于长read，尤其是Sanger-based assembly。后者因内存效率而被采用。

K-mer: 将任意长度的read打断为多个重叠的序列，这些序列的固定长度为k。

究竟使用多大的k值？K值越小错误越多，unique placement比例越少。

K-mer graphs具有分支，而造成其复杂性，诸如spur（马刺形）/bubble（气泡）/frayed rope（磨损的绳索）

不同的assembler具有不同的表现，取决于repeat程度和杂合度。

现实问题：

+ 是否具有足够的内存
+ 修剪 vs 质量值
+ paried-end vs 长read
+ 如果引入更多的错误，那么更多的数据是不需要的

总之，
Asembly和mapping是处理NGS数据的两种基本方法。

### BASH for Genomics

通过使用多种genomics文件类型学习shell的几个功能：

+ 下载数据

处理genomics文件时总是需要用到shell，虽然这不是官方的shell教程，我们将用到许多bash功能。

首先，我们将下载一个zip文件，可使用wget和curl进行。

```bash
which curl
which wget
wget https://www.dropbox.com/s/alz96ei6udjazu3/Genomics.zip
curl -LO https://www.dropbox.com/s/alz96ei6udjazu3/Genomics.zip
```

然后，检查数据。一般基因组数据比较大而容易出错，可使用MD5信息进行检查。

```bash
which md5
which md5sum
md5 Genomics.zip
md5sum Genomics.zip
md5 GenomicsLesson.zip
MD5 (GenomicsLesson.zip) = 322b4f856846fce3c9b7c507f18ee12c
```

+ 处理压缩文件

两种常见的压缩文件格式为zip和gzip。

**zip**:

解压命令：`unzip [file.zip]`,可以添加`-l`参数查看其中包含的文件。

压缩命令：`zip [target.zip] [files.list]`

如需压缩目录则需要添加`-r`参数。

**gzip**:

与zip解压命令相似有：

```bash
gunzip [bunble.gz]
gunzip -l [bunble.zip]
```

**Tarball打包工具**

常见的打包文件格式有：`.tar, .tar.gz, .tgz`，

查看包命令有：

```bash
tar -tf [thisfile.tar]
tar -ztcf [thisfile.tar.gz]
tar -ztvf [tacofile.tgz]
```

解包命令有：

```bash
tar -xf [thisfile.tar]
tar -zxvf [thatfile.tar.gz]
tar -zxvf [tacofile.tgz]
```

+ 查看数据文件

在处理和分析基因组学pipeline的每一步都会产生新的文件格式，如gff。其实大多想fastq文件。

首先，看看目录下有哪些文件：

```bash
ls
ls -lah
```

**SAM & BAM**

SAM文件是tab分隔的文件，描述read如何align到序列上的。它们通常以head lines(@)开始，然后是真正的alignment。

BAM文件保存相同的信息，但是是二进制格式，使得计算机可以更快速地处理。

```bash
head 12724.bam
head 12724.sam
head -20 12724.sam
head -100 12724.sam
tail -20 12724.sam
```


